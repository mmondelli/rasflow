#!/bin/bash

db=$1
#fastq=$2
#b30=$3
runId=$2

SQLITE_CMD="sqlite3 $db"

for i in $(ls *.log)
do
  echo $i
  id=$(echo "select f.file_id from file f natural join staged_out s where f.name like '$i' and s.app_exec_id like '%$runId%';" | $SQLITE_CMD)
  echo $id
  value1=$(cat -n $i | grep -n ^ | grep ^1 | cut -d: -f2 | awk '{print $2}') 
  key1=$(cat -n $i | grep -n ^ | grep ^1 | cut -d: -f2 | awk '{print $3}' | cut -f 1 -d ';') 

  value2=$(cat -n $i | grep -n ^ | grep ^2 | cut -d: -f2 | awk '{print $2}') 
  key2=$(cat -n $i | grep -n ^ | grep ^2 | cut -d: -f2 | awk '{print $5}' | cut -f 1 -d ';') 
  
  value3=$(cat -n $i | grep -n ^ | grep ^3 | cut -d: -f2 | awk '{print $2}') 
  key3=$(cat -n $i | grep -n ^ | grep ^3 | cut -d: -f2 | awk '{$1=$2=$3="";print}' | cut -d ' ' -f4,5,6-) 
  
  value4=$(cat -n $i | grep -n ^ | grep ^4 | cut -d: -f2 | awk '{print $2}') 
  key4=$(cat -n $i | grep -n ^ | grep ^4 | cut -d: -f2 | awk '{$1=$2=$3="";print}' | cut -d ' ' -f4,5,6-) 
  
  value5=$(cat -n $i | grep -n ^ | grep ^5 | cut -d: -f2 | awk '{print $2}')
  key5=$(cat -n $i | grep -n ^ | grep ^5 | cut -d: -f2 | awk '{$1=$2=$3="";print}' | cut -d ' ' -f4,5,6-)  
  
  value6=$(cat -n $i | grep -n ^ | grep ^6 | cut -d: -f2 | awk '{print $2}')
  key6=$(cat -n $i | grep -n ^ | grep ^6 | cut -d: -f2 | awk '{$1=$2="";print}' | cut -d ' ' -f3,4,5-)

  #value7=$(cat -n $i | grep -n ^ | grep ^1 | cut -d: -f3 | tr -d \')
  #key7=$(cat -n $i | grep -n ^ | grep ^1 | cut -d: -f2 | awk '{print $2}' )
  #value8=$(cat -n $i | grep -n ^ | grep ^2 | cut -d: -f3 | tr -d \')
  #key8=$(cat -n $i | grep -n ^ | grep ^2 | cut -d: -f2 | awk '{print $2}')


  echo "INSERT INTO file_annot_numeric VALUES ('$id', '$key1', '$value1');" | $SQLITE_CMD 
  echo "INSERT INTO file_annot_numeric VALUES ('$id', '$key2', '$value2');" | $SQLITE_CMD 
  echo "INSERT INTO file_annot_numeric VALUES ('$id', '$key3', '$value3');" | $SQLITE_CMD 
  echo "INSERT INTO file_annot_numeric VALUES ('$id', '$key4', '$value4');" | $SQLITE_CMD 
  echo "INSERT INTO file_annot_numeric VALUES ('$id', '$key5', '$value5');" | $SQLITE_CMD 
  echo "INSERT INTO file_annot_numeric VALUES ('$id', '$key6', '$value6');" | $SQLITE_CMD 
  #echo "INSERT INTO file_annot_text VALUES ('$id', '$key7', '$value7');" | $SQLITE_CMD 
  #echo "INSERT INTO file_annot_text VALUES ('$id', '$key8', '$value8');" | $SQLITE_CMD 
  
done

for j in $(ls *.fastq)
do
  echo $j
  id=$(echo "select f.file_id from file f natural join staged_in s where f.name like '$j' and s.app_exec_id like '%$runId%';" | $SQLITE_CMD) 
  echo $id
  total_fastq=$(awk '/@/' $j | wc -l) 
  echo "INSERT INTO file_annot_numeric VALUES ('$id', 'number of sequences', '$total_fastq');" | $SQLITE_CMD 
done

for k in $(ls *.bigger30.fq)
do
  echo $k
  id=$(echo "select f.file_id from file f natural join staged_out s where f.name like '$k' and s.app_exec_id like '%$runId%';" | $SQLITE_CMD) 
  echo $id
  total_b30=$(awk '/@/' $k | wc -l) 
  echo "INSERT INTO file_annot_numeric VALUES ('$id', 'filtered sequences (>=30)', '$total_b30');" | $SQLITE_CMD 
done

